<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منظومة الرصد الذكية لدرجات الطالب</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #1abc9c;
            --danger: #e74c3c;
            --success: #27ae60;
            --bg: #f0f2f5;
            --card-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding-bottom: 80px;
            direction: rtl;
            color: #1a202c;
        }

        .app-header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-left { display: flex; align-items: center; gap: 12px; }
        
        .voice-master-btn {
            background: #4a5568;
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            transition: 0.3s;
        }
        .voice-master-btn.active { background: var(--danger); box-shadow: 0 0 10px rgba(231, 76, 60, 0.5); }

        .tabs {
            display: flex;
            gap: 5px;
            padding: 10px;
            overflow-x: auto;
            background: white;
            border-bottom: 2px solid #e2e8f0;
            scrollbar-width: none;
        }
        .tabs::-webkit-scrollbar { display: none; }

        .tab-btn {
            padding: 10px 18px;
            border: none;
            background: #edf2f7;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            white-space: nowrap;
            transition: 0.3s;
            color: #4a5568;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tab-btn.active { background: var(--accent); color: white; }

        .container { width: 100%; max-width: 1400px; margin: 0 auto; padding: 10px; }

        .card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--card-shadow);
            margin-bottom: 15px;
        }

        .student-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
        }
        @media (min-width: 768px) { .student-item { flex-direction: row; align-items: center; justify-content: space-between; } }

        .student-name { font-weight: bold; font-size: 1rem; color: var(--primary); margin-bottom: 10px; transition: 0.2s; }
        .highlight-name { color: #3182ce !important; transform: scale(1.02); }

        .inputs-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        @media (min-width: 768px) { .inputs-row { display: flex; gap: 15px; } }

        .input-box { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .input-box label { font-size: 11px; color: #718096; font-weight: bold; }

        .score-input, .grid-input {
            width: 60px;
            padding: 10px 2px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            font-weight: 900;
            font-size: 1.2rem;
            outline: none;
            transition: 0.2s;
        }
        .score-input:focus, .grid-input:focus { border-color: var(--accent); background: #f0fff4; }

        .mic-btn {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mic-btn.listening { background: var(--danger); color: white; animation: pulse 1s infinite; }
        .mic-hidden { display: none !important; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* تعديل رأس الجدول للشيت الكامل */
        th { background: #cbd5e0; color: #000; padding: 12px 6px; border: 1px solid #a0aec0; white-space: nowrap; text-align: center; font-weight: 900; }
        td { padding: 8px 4px; border: 1px solid #e2e8f0; text-align: center; font-weight: bold; }
        
        .sticky-col { position: sticky; right: 0; background: white; z-index: 10; border-left: 3px solid #cbd5e0 !important; }

        .footer-marquee {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: var(--primary);
            color: white;
            padding: 8px 0;
            font-weight: bold;
            z-index: 1000;
        }

        #toast {
            position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%);
            background: #2d3748; color: white; padding: 12px 25px; border-radius: 25px; display: none; z-index: 2000;
        }
    </style>
</head>
<body>

<div class="app-header">
    <div class="header-left">
        <i class="fas fa-graduation-cap fa-lg"></i>
        <span style="font-weight: 800;">منظومة الرصد الذكية لدرجات الطالب</span>
    </div>
    <div style="display:flex; gap:10px;">
        <button id="masterVoiceBtn" class="voice-master-btn" onclick="toggleGlobalVoice()">
            <i class="fas fa-microphone-slash"></i> <span>الصوت معطل</span>
        </button>
        <button class="btn btn-success" style="padding: 8px 15px;" onclick="saveData()">
            <i class="fas fa-save"></i>
        </button>
    </div>
</div>

<div class="tabs" id="appTabs" style="display:none;">
    <button class="tab-btn active" onclick="switchTab('grading')"><i class="fas fa-calendar-alt"></i> الرصد الأسبوعي</button>
    <button class="tab-btn" onclick="switchTab('fullSheet')"><i class="fas fa-table"></i> الشيت الكامل</button>
    <button class="tab-btn" onclick="switchTab('report')"><i class="fas fa-file-invoice"></i> التقرير الختامي</button>
    <button class="tab-btn" onclick="switchTab('tools')"><i class="fas fa-tools"></i> الأدوات</button>
</div>

<div class="container">
    <div id="setup-screen" class="card">
        <h3><i class="fas fa-cogs"></i> تهيئة المنظومة</h3>
        <input type="text" id="subjectName" class="form-control" placeholder="المادة الدراسية">
        <input type="text" id="gradeLevel" class="form-control" placeholder="الصف والفصل">
        <input type="text" id="teacherName" class="form-control" placeholder="اسم المعلم">
        <textarea id="namesList" class="form-control" style="height:150px;" placeholder="أدخل الأسماء هنا..."></textarea>
        <button class="btn btn-primary" style="width:100%" onclick="initApp()">تشغيل المنظومة</button>
    </div>

    <div id="grading-screen" style="display:none;">
        <div class="info-header" id="gradingInfo"></div>
        <div class="card" style="padding:10px;">
            <select id="weekSelect" class="form-control" onchange="renderStudents()">
                <option value="w1">الأسبوع 1</option><option value="w2">الأسبوع 2</option>
                <option value="ex1">اختبار الشهر 1</option>
            </select>
        </div>
        <div id="studentsContainer"></div>
    </div>

    <div id="fullSheet-screen" class="card" style="display:none;">
        <div class="info-header" id="sheetInfo"></div>
        <div class="table-scroll" id="fullSheetContainer"></div>
    </div>

    <div id="report-screen" class="card" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">التقرير الختامي</h3>
            <button class="btn btn-success" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> تصدير إكسيل</button>
        </div>
        <div id="tableContainer"></div>
    </div>

    <div id="tools-screen" class="card" style="display:none;">
        <button class="btn btn-primary" style="width:100%; margin-bottom:12px;" onclick="exportFullData()">تصدير نسخة احتياطية (JSON)</button>
        <button class="btn btn-danger" style="width:100%;" onclick="clearSystem()">حذف البيانات</button>
    </div>
</div>

<div class="footer-marquee">
    <marquee behavior="scroll" direction="right">
        بواسطة الأستاذ: محمود عادل صالح | هاتف: ٠١٥٥٢٤٠٢٩١٢ | منظومة الرصد الذكية لدرجات الطالب الإصدار الرابع
    </marquee>
</div>

<div id="toast"></div>

<script>
    let students = [];
    let db = {};
    let settings = { subject: '', grade: '', teacher: '' };
    let isVoiceEnabled = false;
    let recognition = null;
    
    const weeksList = ['w1','w2','w3','w4','w5','ex1','w6','w7','w8','w9','w10','ex2'];
    const egyMap = {'صفر':0,'واحد':1,'اتنين':2,'تلاتة':3,'اربعة':4,'خمسة':5,'ستة':6,'سبعة':7,'تمانية':8,'تسعة':9,'عشرة':10};

    function showToast(m) {
        const t = document.getElementById('toast');
        t.innerText = m; t.style.display = 'block';
        setTimeout(() => t.style.display='none', 2000);
    }

    function toggleGlobalVoice() {
        isVoiceEnabled = !isVoiceEnabled;
        const btn = document.getElementById('masterVoiceBtn');
        btn.classList.toggle('active', isVoiceEnabled);
        btn.innerHTML = isVoiceEnabled ? '<i class="fas fa-microphone"></i> <span>الصوت مفعل</span>' : '<i class="fas fa-microphone-slash"></i> <span>الصوت معطل</span>';
        if(isVoiceEnabled) showToast("تم تفعيل الرصد التلقائي عند الوقوف على الخانة");
    }

    function initApp() {
        const raw = document.getElementById('namesList').value.trim();
        if(!raw) return alert("يرجى إدخال أسماء الطلاب");
        settings = {
            subject: document.getElementById('subjectName').value || 'مادة غير محددة',
            grade: document.getElementById('gradeLevel').value || 'فصل غير محدد',
            teacher: document.getElementById('teacherName').value || 'معلم غير محدد'
        };
        students = raw.split('\n').map(n => n.trim()).filter(n => n);
        students.forEach((_, i) => { if(!db[i]) db[i] = {}; });
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('appTabs').style.display = 'flex';
        updateHeaders();
        switchTab('grading');
        saveDataSilent();
    }

    function updateHeaders() {
        const html = `<span><i class="fas fa-book"></i> ${settings.subject}</span> <span><i class="fas fa-users"></i> ${settings.grade}</span> <span><i class="fas fa-user-tie"></i> ${settings.teacher}</span>`;
        document.getElementById('gradingInfo').innerHTML = html;
        if(document.getElementById('sheetInfo')) document.getElementById('sheetInfo').innerHTML = html;
    }

    function switchTab(t) {
        document.querySelectorAll('[id$="-screen"]').forEach(s => s.style.display = 'none');
        document.getElementById(t + '-screen').style.display = 'block';
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        if(t === 'grading') renderStudents();
        if(t === 'fullSheet') renderFullSheet();
        if(t === 'report') renderFinalReport();
    }

    function renderStudents() {
        const cont = document.getElementById('studentsContainer');
        const week = document.getElementById('weekSelect').value;
        const isEx = week.startsWith('ex');
        cont.innerHTML = '';
        students.forEach((name, i) => {
            const d = db[i][week] || {t:'', v:'', s:''};
            const div = document.createElement('div');
            div.className = 'student-item';
            div.innerHTML = `
                <div class="student-name" id="name_weekly_${i}">${i+1}. ${name}</div>
                <div class="inputs-row">
                    ${createInput(i, week, 't', isEx?30:15, d.t, 'weekly', isEx?'اختبار':'تقييم')}
                    ${!isEx ? createInput(i, week, 'v', 15, d.v, 'weekly', 'حصة') : ''}
                    ${!isEx ? createInput(i, week, 's', 10, d.s, 'weekly', 'سلوك') : ''}
                </div>
            `;
            cont.appendChild(div);
        });
    }

    function createInput(idx, w, f, max, val, context, label) {
        const id = `${context}_${idx}_${w}_${f}`;
        return `
            <div class="input-box">
                <label>${label}</label>
                <input type="number" id="${id}" class="score-input" value="${val}"
                    onfocus="handleFocus(this, ${idx}, '${context}', ${max}, ${idx}, '${w}', '${f}')"
                    onblur="handleBlur(${idx}, '${context}')"
                    onkeydown="handleNav(event, ${idx}, '${w}', '${f}')"
                    onchange="updateScore(${idx}, '${w}', '${f}', this.value, ${max})">
            </div>
        `;
    }

    // الرصد الصوتي التلقائي عند التركيز
    function handleFocus(el, idx, context, max, i, w, f) {
        const nameEl = document.getElementById(`name_${context}_${idx}`);
        if(nameEl) nameEl.classList.add('highlight-name');
        
        if(isVoiceEnabled) {
            startAutoListen(el.id, max, i, w, f);
        }
    }

    function handleBlur(idx, context) {
        const nameEl = document.getElementById(`name_${context}_${idx}`);
        if(nameEl) nameEl.classList.remove('highlight-name');
        if(recognition) { recognition.stop(); }
    }

    function startAutoListen(targetId, max, idx, w, f) {
        if (!('webkitSpeechRecognition' in window)) return;
        
        recognition = new webkitSpeechRecognition();
        recognition.lang = 'ar-EG';
        recognition.continuous = false;

        recognition.onstart = () => {
            document.getElementById(targetId).style.backgroundColor = "#fff5f5";
            document.getElementById(targetId).style.borderColor = "red";
        };

        recognition.onresult = (e) => {
            let transcript = e.results[0][0].transcript;
            let v = parseFloat(transcript);
            if(isNaN(v)) { for(let k in egyMap) if(transcript.includes(k)) v = egyMap[k]; }
            
            if(!isNaN(v)) {
                v = Math.min(v, max);
                document.getElementById(targetId).value = v;
                updateScore(idx, w, f, v, max);
                handleNav({key:'Enter', preventDefault:()=>{}}, idx, w, f);
            }
        };

        recognition.onend = () => {
            document.getElementById(targetId).style.backgroundColor = "";
            document.getElementById(targetId).style.borderColor = "";
        };

        recognition.start();
    }

    function handleNav(e, idx, w, f) {
        if(e.key === 'Enter') {
            e.preventDefault();
            let nextId = "";
            const isEx = w.startsWith('ex');
            const context = document.getElementById('fullSheet-screen').style.display === 'block' ? 'grid' : 'weekly';

            if(f === 't' && !isEx) nextId = `${context}_${idx}_${w}_v`;
            else if(f === 'v') nextId = `${context}_${idx}_${w}_s`;
            else { 
                if(idx < students.length - 1) nextId = `${context}_${idx+1}_${w}_t`;
            }

            const nextEl = document.getElementById(nextId);
            if(nextEl) { nextEl.focus(); nextEl.select(); }
        }
    }

    function updateScore(idx, w, f, v, max) {
        if(!db[idx][w]) db[idx][w] = {};
        db[idx][w][f] = v === '' ? '' : Math.min(parseFloat(v), max);
        saveDataSilent();
    }

    function renderFullSheet() {
        const cont = document.getElementById('fullSheetContainer');
        let html = `<table><thead><tr><th rowspan="2" class="sticky-col">الأسماء</th>`;
        weeksList.forEach((w, i) => {
            const isEx = w.startsWith('ex');
            html += `<th colspan="${isEx?1:3}">${w.replace('w','أسبوع ').replace('ex','اختبار')}</th>`;
        });
        html += `</tr><tr>`;
        weeksList.forEach((w) => {
            const isEx = w.startsWith('ex');
            if(isEx) html += `<th>د</th>`;
            else html += `<th>ت</th><th>ح</th><th>س</th>`;
        });
        html += `</tr></thead><tbody>`;

        students.forEach((name, i) => {
            html += `<tr><td class="sticky-col student-name" id="name_grid_${i}">${name}</td>`;
            weeksList.forEach((w) => {
                const isEx = w.startsWith('ex');
                const d = db[i][w] || {t:'', v:'', s:''};
                html += `<td><input type="number" id="grid_${i}_${w}_t" class="grid-input" value="${d.t}" onfocus="handleFocus(this, ${i}, 'grid', ${isEx?30:15}, ${i}, '${w}', 't')" onblur="handleBlur(${i}, 'grid')" onkeydown="handleNav(event, ${i}, '${w}', 't')" onchange="updateScore(${i},'${w}','t',this.value, ${isEx?30:15})"></td>`;
                if(!isEx) {
                    html += `<td><input type="number" id="grid_${i}_${w}_v" class="grid-input" value="${d.v}" onfocus="handleFocus(this, ${i}, 'grid', 15, ${i}, '${w}', 'v')" onblur="handleBlur(${i}, 'grid')" onkeydown="handleNav(event, ${i}, '${w}', 'v')" onchange="updateScore(${i},'${w}','v',this.value, 15)"></td>`;
                    html += `<td><input type="number" id="grid_${i}_${w}_s" class="grid-input" value="${d.s}" onfocus="handleFocus(this, ${i}, 'grid', 10, ${i}, '${w}', 's')" onblur="handleBlur(${i}, 'grid')" onkeydown="handleNav(event, ${i}, '${w}', 's')" onchange="updateScore(${i},'${w}','s',this.value, 10)"></td>`;
                }
            });
            html += `</tr>`;
        });
        cont.innerHTML = html + `</tbody></table>`;
    }

    function renderFinalReport() {
        let html = `<table style="width:100%"><thead><tr><th>م</th><th>الاسم</th><th>الدرجة النهائية (70)</th></tr></thead><tbody>`;
        students.forEach((name, i) => {
            html += `<tr><td>${i+1}</td><td>${name}</td><td>رصد آلي</td></tr>`;
        });
        document.getElementById('tableContainer').innerHTML = html + `</tbody></table>`;
    }

    function saveData() { saveDataSilent(); showToast("تم حفظ البيانات بنجاح"); }
    function saveDataSilent() { localStorage.setItem('mahmoud_v4_db', JSON.stringify({students, db, settings})); }
    
    // التصدير بالاسم المطلوب
    function getExportName() {
        return `${settings.subject}_${settings.teacher}_${settings.grade}`.replace(/ /g, '_');
    }

    function exportToExcel() {
        const ws = XLSX.utils.json_to_sheet(students.map((n, i) => ({'الاسم': n})));
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "الدرجات");
        XLSX.writeFile(wb, `${getExportName()}.xlsx`);
    }

    function exportFullData() {
        const blob = new Blob([JSON.stringify({students, db, settings})], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); 
        a.download = `نسخة_احتياطية_${getExportName()}.json`; a.click();
    }

    function clearSystem() { if(confirm("حذف كل البيانات؟")) { localStorage.clear(); location.reload(); } }

    window.onload = () => {
        const saved = localStorage.getItem('mahmoud_v4_db');
        if(saved) {
            const data = JSON.parse(saved);
            students = data.students; db = data.db; settings = data.settings;
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('appTabs').style.display = 'flex';
            updateHeaders(); switchTab('grading');
        }
    };
</script>
</body>
</html>
