<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منظومة الرصد النهائية - الإصدار المعتمد</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #2c3e50; --accent: #1abc9c; --danger: #e74c3c; --success: #27ae60; --bg: #f0f2f5; }
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: var(--bg); margin: 0; direction: rtl; padding-bottom: 60px; }
        
        .app-header { background: var(--primary); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .tabs { display: flex; gap: 5px; padding: 10px; overflow-x: auto; background: white; border-bottom: 2px solid #ddd; }
        .tab-btn { padding: 10px 20px; border: none; background: #eee; border-radius: 8px; cursor: pointer; font-weight: bold; white-space: nowrap; transition: 0.3s; }
        .tab-btn.active { background: var(--accent); color: white; }
        
        .container { width: 98%; max-width: 1600px; margin: 15px auto; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        .table-scroll { overflow-x: auto; max-height: 75vh; border: 1px solid #ccc; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; background: white; }
        th { background: #34495e; color: white; border: 1px solid #455a64; padding: 8px 2px; position: sticky; top: 0; z-index: 5; }
        td { border: 1px solid #cfd8dc; text-align: center; padding: 4px; font-weight: 900; }
        .sticky-col { position: sticky; right: 0; background: #f8f9fa; z-index: 10; border-left: 3px solid #7f8c8d !important; }
        
        .subtotal-col { background: #e3f2fd !important; color: #1565c0; border: 1px solid #bbdefb; }
        .final-col { background: #e8f5e9 !important; color: #2e7d32; border: 1px solid #c8e6c9; }
        
        .score-input { width: 42px; border: 1px solid #bdc3c7; text-align: center; border-radius: 4px; padding: 5px 0; font-weight: bold; }
        .score-input:focus { border-color: var(--accent); background: #f0fdfa; outline: none; }

        .footer-marquee { position: fixed; bottom: 0; width: 100%; background: var(--primary); color: white; padding: 6px 0; z-index: 1000; font-weight: bold; }
    </style>
</head>
<body>

<div class="app-header">
    <div style="font-size: 1.1rem; font-weight: bold;"><i class="fas fa-layer-group"></i> منظومة الرصد الذكية - التقرير الختامي الصارم</div>
    <button class="tab-btn" style="background:var(--success); color:white; border-radius: 5px;" onclick="saveData(true)"><i class="fas fa-save"></i> حفظ التغييرات</button>
</div>

<div class="tabs" id="mainTabs" style="display:none;">
    <button class="tab-btn active" onclick="switchTab('grading')">الرصد الأسبوعي</button>
    <button class="tab-btn" onclick="switchTab('fullSheet')">الشيت الكامل</button>
    <button class="tab-btn" onclick="switchTab('export')">تصدير مخصص</button>
    <button class="tab-btn" onclick="switchTab('tools')">الأدوات</button>
</div>

<div class="container">
    <div id="setup-screen" class="card">
        <h3><i class="fas fa-database"></i> إعداد المنظومة واستيراد البيانات</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px;">
            <input type="text" id="deptName" placeholder="الإدارة التعليمية" class="card" style="padding:12px;">
            <input type="text" id="schoolName" placeholder="المدرسة" class="card" style="padding:12px;">
            <input type="text" id="subjectName" placeholder="المادة الدراسية" class="card" style="padding:12px;">
            <input type="text" id="gradeLevel" placeholder="الصف" class="card" style="padding:12px;">
            <input type="text" id="classRoom" placeholder="الفصل" class="card" style="padding:12px;">
            <input type="text" id="teacherName" placeholder="اسم المعلم" class="card" style="padding:12px;">
        </div>
        <div style="margin-top:20px; border-top: 1px solid #eee; padding-top: 15px;">
            <label><b>إدارة الأسماء:</b></label>
            <div style="margin-top:10px;">
                <input type="file" id="fileImport" accept=".xlsx, .xls, .txt" style="display:none;" onchange="handleFileImport(this)">
                <button onclick="document.getElementById('fileImport').click()" class="tab-btn" style="background:#2980b9; color:white;"><i class="fas fa-file-excel"></i> استيراد من ملف</button>
            </div>
            <textarea id="namesArea" class="card" style="width:100%; height:150px; margin-top:10px; border:1px solid #cbd5e0;" placeholder="أدخل الأسماء هنا (اسم في كل سطر)"></textarea>
        </div>
        <button class="tab-btn" style="width:100%; background:var(--primary); color:white; padding:18px; font-size:1.2rem; margin-top:10px;" onclick="initializeSystem()">تشغيل المنظومة الآن</button>
    </div>

    <div id="grading-screen" style="display:none;">
        <div id="infoBar" class="card" style="background:#e3f2fd; color:#0d47a1; font-weight:bold; border-right: 5px solid #2196f3;"></div>
        <select id="weekPicker" class="card" style="width:100%; font-size:1.1rem; padding:12px;" onchange="renderWeeklyList()"></select>
        <div id="weeklyList"></div>
    </div>

    <div id="fullSheet-screen" class="card" style="display:none;">
        <div class="table-scroll" id="fullSheetTable"></div>
    </div>

    <div id="export-screen" class="card" style="display:none;">
        <h3><i class="fas fa-file-export"></i> لوحة التحكم في التصدير</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
            <div class="card" style="border: 1px solid #ddd;">
                <h4><i class="fas fa-users"></i> نطاق الطلاب</h4>
                من الطالب رقم: <input type="number" id="stStart" value="1" style="width:70px; padding:5px;"> <br><br>
                إلى الطالب رقم: <input type="number" id="stEnd" style="width:70px; padding:5px;">
            </div>
            <div class="card" style="border: 1px solid #ddd;">
                <h4><i class="fas fa-calendar-check"></i> الأسابيع المشمولة</h4>
                <div id="exportWeeks" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;"></div>
            </div>
            <div class="card" style="border: 1px solid #ddd; text-align: center;">
                <h4><i class="fas fa-check-circle"></i> تنفيذ التصدير</h4>
                <button class="tab-btn" style="width:100%; background:var(--success); color:white; margin-bottom:10px;" onclick="runExport('xlsx')"><i class="fas fa-file-excel"></i> تصدير Excel</button>
                <button class="tab-btn" style="width:100%; background:var(--danger); color:white;" onclick="runExport('pdf')"><i class="fas fa-file-pdf"></i> تصدير PDF رسمي</button>
            </div>
        </div>
    </div>

    <div id="tools-screen" class="card" style="display:none;">
        <button class="tab-btn" style="width:100%; margin-bottom:10px;" onclick="backupJSON()">تصدير نسخة JSON للنسخ الاحتياطي</button>
        <button class="tab-btn" style="width:100%; background:var(--danger); color:white;" onclick="resetSystem()">مسح كافة البيانات وإعادة التصفير</button>
    </div>
</div>

<div id="pdf-container" style="display:none; background:white; padding:30px;"></div>

<div class="footer-marquee">
    <marquee direction="right">بواسطة الأستاذ: محمود عادل صالح | هاتف: ٠١٥٥٢٤٠٢٩١٢ | منظومة الرصد الذكية لدرجات الطالب</marquee>
</div>

<script>
    let students = [];
    let db = {};
    let settings = {};
    const WEEKS = [
        {id:'w1', n:'الأسبوع 1'}, {id:'w2', n:'الأسبوع 2'}, {id:'w3', n:'الأسبوع 3'}, {id:'w4', n:'الأسبوع 4'}, {id:'w5', n:'الأسبوع 5'},
        {id:'ex1', n:'اختبار 1', isEx:true},
        {id:'w6', n:'الأسبوع 6'}, {id:'w7', n:'الأسبوع 7'}, {id:'w8', n:'الأسبوع 8'}, {id:'w9', n:'الأسبوع 9'}, {id:'w10', n:'الأسبوع 10'},
        {id:'ex2', n:'اختبار 2', isEx:true},
        {id:'w11', n:'الأسبوع 11'}, {id:'w12', n:'الأسبوع 12'}
    ];

    function handleFileImport(input) {
        const file = input.files[0];
        const reader = new FileReader();
        if(file.name.endsWith('.txt')) {
            reader.onload = (e) => document.getElementById('namesArea').value = e.target.result;
            reader.readAsText(file);
        } else {
            reader.onload = (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const names = XLSX.utils.sheet_to_json(sheet, {header:1}).map(r => r[0]).filter(n => n);
                document.getElementById('namesArea').value = names.join('\n');
            };
            reader.readAsArrayBuffer(file);
        }
    }

    function initializeSystem() {
        const rawNames = document.getElementById('namesArea').value.trim();
        if(!rawNames) return alert("الرجاء إدخال أسماء الطلاب أولاً");
        
        students = rawNames.split('\n').map(n => n.trim()).filter(n => n);
        settings = {
            dept: document.getElementById('deptName').value || '.......',
            school: document.getElementById('schoolName').value || '.......',
            subject: document.getElementById('subjectName').value || '.......',
            grade: document.getElementById('gradeLevel').value || '.......',
            class: document.getElementById('classRoom').value || '.......',
            teacher: document.getElementById('teacherName').value || '.......'
        };

        students.forEach((_, i) => { if(!db[i]) db[i] = {}; });
        
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('mainTabs').style.display = 'flex';
        document.getElementById('stEnd').value = students.length;
        
        document.getElementById('weekPicker').innerHTML = WEEKS.map(w => `<option value="${w.id}">${w.n}</option>`).join('');
        document.getElementById('exportWeeks').innerHTML = WEEKS.map(w => `<div><input type="checkbox" class="exp-w-chk" value="${w.id}" checked> ${w.n}</div>`).join('');
        
        document.getElementById('infoBar').innerHTML = `<i class="fas fa-info-circle"></i> ${settings.subject} | ${settings.grade} | فصل: ${settings.class} | أ/ ${settings.teacher}`;
        
        switchTab('grading');
        saveData();
    }

    function switchTab(t) {
        document.querySelectorAll('[id$="-screen"]').forEach(s => s.style.display = 'none');
        document.getElementById(t + '-screen').style.display = 'block';
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        if(event) event.currentTarget.classList.add('active');
        if(t === 'grading') renderWeeklyList();
        if(t === 'fullSheet') renderFullSheet();
    }

    function updateVal(idx, wid, field, val) {
        if(!db[idx][wid]) db[idx][wid] = {t:'', v:'', s:''};
        let n = val === '' ? '' : parseFloat(val);
        const wInfo = WEEKS.find(w=>w.id===wid);
        if(field==='t') n = Math.min(n, wInfo.isEx ? 30 : 15);
        if(field==='v') n = Math.min(n, 15);
        if(field==='s') n = Math.min(n, 10);
        
        db[idx][wid][field] = n;
        saveData();
    }

    function renderWeeklyList() {
        const wid = document.getElementById('weekPicker').value;
        const isEx = WEEKS.find(w=>w.id===wid).isEx;
        let h = '';
        students.forEach((name, i) => {
            const d = db[i][wid] || {t:'', v:'', s:''};
            h += `
            <div class="card" style="display:flex; justify-content:space-between; align-items:center; padding:10px; border:1px solid #eee;">
                <span><b>${i+1}.</b> ${name}</span>
                <div style="display:flex; gap:10px;">
                    <div style="text-align:center"><small style="display:block">ت</small><input type="number" class="score-input" value="${d.t}" onchange="updateVal(${i},'${wid}','t',this.value)"></div>
                    ${!isEx ? `
                    <div style="text-align:center"><small style="display:block">ح</small><input type="number" class="score-input" value="${d.v}" onchange="updateVal(${i},'${wid}','v',this.value)"></div>
                    <div style="text-align:center"><small style="display:block">س</small><input type="number" class="score-input" value="${d.s}" onchange="updateVal(${i},'${wid}','s',this.value)"></div>
                    ` : ''}
                </div>
            </div>`;
        });
        document.getElementById('weeklyList').innerHTML = h;
    }

    // الحساب الختامي الصارم (متوسط الكل)
    function calcStrictFinal(idx) {
        let sumT=0, sumV=0, sumS=0, countW=0;
        let sumEx=0, countEx=0;

        WEEKS.forEach(w => {
            const d = db[idx][w.id] || {t:'', v:'', s:''};
            if(!w.isEx) {
                sumT += (parseFloat(d.t) || 0);
                sumV += (parseFloat(d.v) || 0);
                sumS += (parseFloat(d.s) || 0);
                countW++;
            } else {
                sumEx += (parseFloat(d.t) || 0);
                countEx++;
            }
        });

        const avgT = sumT / (countW || 1);
        const avgV = sumV / (countW || 1);
        const avgS = sumS / (countW || 1);
        const avgEx = sumEx / (countEx || 1);
        
        return {
            t: avgT, v: avgV, s: avgS, ex: avgEx,
            total: (avgT + avgV + avgS + avgEx).toFixed(1)
        };
    }

    function renderFullSheet() {
        let h = `<table><thead><tr><th rowspan="2" class="sticky-col">الأسماء</th>`;
        WEEKS.forEach(w => h += `<th colspan="${w.isEx?1:3}">${w.n}</th>`);
        h += `<th colspan="5" class="final-col">التقييم النهائي (70)</th></tr><tr>`;
        
        WEEKS.forEach(w => {
            if(w.isEx) h += `<th>درجة</th>`;
            else h += `<th>ت</th><th>ح</th><th>س</th>`;
        });
        // ترويسات النهائي الصارم
        h += `<th>ت (15)</th><th>ح (15)</th><th>س (10)</th><th>اختبار (30)</th><th>مجموع</th></tr></thead><tbody>`;

        students.forEach((name, i) => {
            const final = calcStrictFinal(i);
            h += `<tr><td class="sticky-col" style="text-align:right">${name}</td>`;
            WEEKS.forEach(w => {
                const d = db[i][w.id] || {t:'', v:'', s:''};
                h += `<td>${d.t}</td>`;
                if(!w.isEx) h += `<td>${d.v}</td><td>${d.s}</td>`;
            });
            h += `<td class="final-col">${final.t.toFixed(1)}</td>
                  <td class="final-col">${final.v.toFixed(1)}</td>
                  <td class="final-col">${final.s.toFixed(1)}</td>
                  <td class="final-col">${final.ex.toFixed(1)}</td>
                  <td class="final-col" style="background:#c8e6c9 !important;">${final.total}</td></tr>`;
        });
        document.getElementById('fullSheetTable').innerHTML = h + `</tbody></table>`;
    }

    async function runExport(type) {
        const start = (parseInt(document.getElementById('stStart').value) || 1) - 1;
        const end = parseInt(document.getElementById('stEnd').value) || students.length;
        const selectedWids = Array.from(document.querySelectorAll('.exp-w-chk:checked')).map(c => c.value);
        
        let header = `
            <div dir="rtl" style="margin-bottom:15px;">
                <table style="width:100%; border:none; font-weight:bold;">
                    <tr><td>إدارة: ${settings.dept}</td><td style="text-align:center">المادة: ${settings.subject}</td><td style="text-align:left">المعلم: ${settings.teacher}</td></tr>
                    <tr><td>مدرسة: ${settings.school}</td><td style="text-align:center">الصف: ${settings.grade}</td><td style="text-align:left">الفصل: ${settings.class}</td></tr>
                </table>
                <h2 style="text-align:center; text-decoration:underline;">كشف رصد الدرجات الرسمي</h2>
            </div>`;

        let table = `<table border="1" dir="rtl" style="width:100%; border-collapse:collapse; text-align:center; font-size:11px;">
            <thead><tr style="background:#eee;"><th>م</th><th>الاسم</th>`;
        selectedWids.forEach(wid => {
            const w = WEEKS.find(x => x.id === wid);
            table += `<th colspan="${w.isEx?1:3}">${w.n}</th>`;
        });
        table += `<th>المجموع</th></tr><tr style="background:#eee;"><th></th><th></th>`;
        selectedWids.forEach(wid => {
            const w = WEEKS.find(x => x.id === wid);
            if(w.isEx) table += `<th>درجة</th>`;
            else table += `<th>ت</th><th>ح</th><th>س</th>`;
        });
        table += `<th>(70)</th></tr></thead><tbody>`;

        for(let i=start; i<end; i++) {
            if(!students[i]) continue;
            const res = calcStrictFinal(i);
            table += `<tr><td>${i+1}</td><td style="text-align:right; padding:2px 5px;">${students[i]}</td>`;
            selectedWids.forEach(wid => {
                const w = WEEKS.find(x => x.id === wid);
                const d = db[i][wid] || {t:'', v:'', s:''};
                table += `<td>${d.t}</td>`;
                if(!w.isEx) table += `<td>${d.v}</td><td>${d.s}</td>`;
            });
            table += `<td style="font-weight:bold; background:#f9f9f9;">${res.total}</td></tr>`;
        }
        table += `</tbody></table>`;

        if(type === 'pdf') {
            const container = document.getElementById('pdf-container');
            container.innerHTML = header + table;
            container.style.display = 'block';
            const opt = { margin: 0.3, filename: `درجات_${settings.class}.pdf`, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' } };
            await html2pdf().set(opt).from(container).save();
            container.style.display = 'none';
        } else {
            const wb = XLSX.utils.book_new();
            const wsData = [
                [`إدارة: ${settings.dept}`, "", `المادة: ${settings.subject}`, "", `المعلم: ${settings.teacher}`],
                [`مدرسة: ${settings.school}`, "", `الصف: ${settings.grade}`, "", `الفصل: ${settings.class}`],
                [],
                ["م", "الاسم", ...selectedWids.map(wid => WEEKS.find(x=>x.id===wid).n), "المجموع النهائي"]
            ];
            for(let i=start; i<end; i++) {
                if(!students[i]) continue;
                const row = [i+1, students[i]];
                selectedWids.forEach(wid => row.push(db[i][wid]?.t || '0'));
                row.push(calcStrictFinal(i).total);
                wsData.push(row);
            }
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, `رصد_${settings.class}.xlsx`);
        }
    }

    function saveData(notify=false) { 
        localStorage.setItem('mahmoud_final_v5', JSON.stringify({students, db, settings})); 
        if(notify) alert("تم تأمين وحفظ البيانات بنجاح");
    }

    function resetSystem() { if(confirm("تحذير: سيتم حذف جميع الدرجات والأسماء نهائياً! هل أنت متأكد؟")) { localStorage.clear(); location.reload(); } }

    window.onload = () => {
        const saved = localStorage.getItem('mahmoud_final_v5');
        if(saved) {
            const data = JSON.parse(saved);
            students = data.students; db = data.db; settings = data.settings;
            document.getElementById('deptName').value = settings.dept;
            document.getElementById('schoolName').value = settings.school;
            document.getElementById('subjectName').value = settings.subject;
            document.getElementById('gradeLevel').value = settings.grade;
            document.getElementById('classRoom').value = settings.class;
            document.getElementById('teacherName').value = settings.teacher;
            document.getElementById('namesArea').value = students.join('\n');
            initializeSystem();
        }
    }
</script>
</body>
</html>
